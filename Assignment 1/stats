#!/bin/bash
#####################
# Kevin Turkington  #
# CS 344            #
# Assignment 1      #
# 10/21/17          #
#####################

#RUN TIME CONSTANTS
FILE=$2
TEMPFILE="$$.tmp"
declare -i ROW=0;
declare -i COL=0;
declare -i ROWMEDIAN;
declare -i COLMEDIAN;

#Checks if File can be found in current directory
#or specified directory.
checkValidFile()
{
    if [ ! -f $FILE ]; then
        echo "$0 cannot read $FILE";
        exit 1;
    fi
}

#Utility for setting run time constants
DimensionsUtil()
{
    # takes first column and counts lines for row
    ROW=$(cut -f 1 $FILE | wc -l);
    # takes first row, replaces tabs with newline and counts lines for column
    COL=$(head -n 1 $FILE | tr '\t' '\n' | wc -l);

    ROWMEDIAN=$(( ($ROW + (1) )/ 2));
    COLMEDIAN=$(( ($COL + (0) )/ 2));

    # echo "ROW: $ROW";
    # echo "COL: $COL";
    # echo "ROWMEDIAN: $ROWMEDIAN";
    # echo "COLMEDIAN: $COLMEDIAN";
}

# reads file and prints a sorted version to a tempfile.
FillFileRow()
{
    while read line; 
    do
        echo $( for i in $line; do echo -e "$i\t";done | sort -n ) | tr ' ' '\t' >> $TEMPFILE
    done < $FILE;
}

# reads file and prints a sorted version to a tempfile.
FillFileCol()
{   
    for i in $(seq 1 $COL); 
    do
        echo "$(cat $FILE | cut -f $i | sort -n | tr '\n' '\t')" >> $TEMPFILE
    done;
}

#cleans tempfile.
Cleanup()
{
    rm $TEMPFILE;
}

rows_func() 
{
    checkValidFile;
    DimensionsUtil;

    FillFileRow;

    echo -e "Average\tMedian";
    #AVG/Median logic
    while read line;
    do
        Sum=0;
        TempArr=();

        for i in $line;
        do
            Sum=$(($Sum+$i));
            TempArr+=("$i");
        done;

        echo -e "$((($Sum +($COL/2))/$COL))\t${TempArr[$ROWMEDIAN]}";

    done < $TEMPFILE;

    Cleanup;

}

cols_func()
{
    checkValidFile; 
    DimensionsUtil;

    FillFileCol;

    AVGstring="";
    MedianString="";

    #AVG/Median logic
    while read line;
    do
        Sum=0;
        TempArr=();

        for i in $line;
        do
            Sum=$(($Sum+$i));
            TempArr+=("$i");
        done;

        AVGstring+="$((($Sum +($ROW/2))/$ROW))\t"
        MedianString+="${TempArr[$COLMEDIAN]}\t";

    done < $TEMPFILE;

    #printing out lines
    echo "Averages:";
    echo -e $AVGstring;
    echo "Medians:"
    echo -e $MedianString;

    Cleanup;
}

#Main
if [ "$#" -gt 2 ] || [ "$#" -lt 1 ]
then
    echo "$0 {-rows|-cols} [file]" >&2
    exit 1;
fi

if [[ "$1" == -r* ]]
then
    rows_func;
    exit 0;
elif [[ "$1" == -c* ]] 
then
    cols_func;
    exit 0;
else
    echo "$0 {-rows|-cols} [file]" >&2
    exit 1;
fi
